<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>🌱 GreenScan - Eco Barcode Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Optional external stylesheet (kept from your file; safe to keep or remove) -->
  <link rel="stylesheet" href="style.css" />

  <!-- Google Fonts: classic + modern pairing -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Camera barcode (live) -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <!-- Image barcode (upload) -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <style>
    :root{
      --bg: #0b1f16;
      --bg-soft: #0f2a1d;
      --card: #0e241b;
      --text: #e7f2ea;
      --muted: #b7c7bf;
      --brand: #2bd07a;
      --brand-600:#1fb96a;
      --brand-700:#149d59;
      --border: rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }

    /* ====== Base ====== */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(43,208,122,.15), rgba(43,208,122,0) 60%),
        radial-gradient(1000px 500px at 120% 10%, rgba(43,208,122,.15), rgba(43,208,122,0) 60%),
        linear-gradient(180deg, #0a1b14, #0b1f16 35%, #0b1f16);
      color:var(--text);
      font-family:"Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height:1.55;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* ====== Top bar / header ====== */
    .app-header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(140%) blur(8px);
      background:linear-gradient(180deg, rgba(11,31,22,.8), rgba(11,31,22,.55));
      border-bottom:1px solid var(--border);
    }
    .nav{
      max-width:1040px; margin:0 auto; padding:14px 20px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text);
    }
    .brand-badge{
      width:36px; height:36px; display:grid; place-items:center;
      border-radius:12px; background:linear-gradient(145deg, var(--brand), var(--brand-600));
      color:#072814; font-weight:800; box-shadow:var(--shadow);
    }
    .brand-title{
      font-family:"Playfair Display", serif; font-weight:700; font-size:1.2rem; letter-spacing:.3px;
    }
    .tagline{ color:var(--muted); font-size:.92rem }

    /* ====== Shell ====== */
    .wrap{ padding:28px 14px 56px }
    .container{
      max-width:1040px; margin:0 auto;
      display:grid; grid-template-columns: 1.1fr .9fr; gap:22px;
    }
    @media (max-width: 980px){
      .container{ grid-template-columns:1fr }
    }

    /* ====== Cards ====== */
    .card{
      background:linear-gradient(180deg, rgba(20,50,38,.6), rgba(14,36,27,.8));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      animation:popIn .5s ease both;
    }
    @keyframes popIn{
      from{ opacity:0; transform:translateY(10px) scale(.98) }
      to{ opacity:1; transform:translateY(0) scale(1) }
    }
    .card-head{
      padding:18px 20px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
    }
    .card-title{
      margin:0; font-weight:700; letter-spacing:.2px; font-size:1.05rem; color:#eaf6f0;
    }
    .card-body{ padding:20px }
    .section-spacer{ height:8px }

    /* ====== Scanner box ====== */
    .scanner{
      width:100%;
      margin:6px auto 10px;
      border:1.5px dashed rgba(255,255,255,.18);
      border-radius:14px;
      min-height:260px;
      background:repeating-linear-gradient(45deg, rgba(255,255,255,.02) 0 8px, rgba(255,255,255,.04) 8px 16px);
      display:grid; place-items:center;
      color:var(--muted);
    }
    .hint{ color:var(--muted); font-size:.92rem; margin-top:8px }

    /* ====== Buttons & inputs ====== */
    .btn{
      appearance:none; border:0; cursor:pointer;
      padding:11px 16px; border-radius:12px; font-weight:600;
      background:#203a2c; color:var(--text);
      transition:transform .06s ease, box-shadow .2s ease, background .2s ease, opacity .2s ease;
      box-shadow:0 6px 18px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.04);
    }
    .btn:hover{ transform:translateY(-1px) }
    .btn:active{ transform:translateY(0) scale(.98) }

    .btn-green{ background:linear-gradient(180deg, var(--brand), var(--brand-600)); color:#042216 }
    .btn-green:hover{ background:linear-gradient(180deg, var(--brand-600), var(--brand-700)) }
    .btn-red{ background:linear-gradient(180deg, #ff5a5a, #e64747); color:#260808 }
    .btn-blue{ background:linear-gradient(180deg, #4aa3ff, #2b7de7); color:#061326 }

    .btn-row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center; }

    .input, input[type="file"]{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
      transition:border .2s ease, box-shadow .2s ease, background .2s ease;
    }
    .input::placeholder{ color: #93a69c }
    .input:focus{
      border-color: rgba(43,208,122,.45);
      box-shadow:0 0 0 4px rgba(43,208,122,.08);
      background:rgba(255,255,255,.05);
    }

    .split{
      display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center;
    }

    /* ====== Result box ====== */
    .result-box{
      display:block;
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid var(--border);
      border-radius:14px;
      padding:18px 16px;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.03);
      animation:fadeIn .35s ease both;
    }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)} }
    .result-box h2{
      margin:0 0 6px; color:#eaf6f0; font-size:1.05rem; letter-spacing:.2px
    }
    .kv{ margin:6px 0; }
    .kv b{ color:#cfe7db; font-weight:600 }

    /* ====== Eco badge (circular) ====== */
    .eco-score{
      --size: 44px;
      width:var(--size); height:var(--size);
      display:inline-grid; place-items:center;
      border-radius:999px; font-weight:800; letter-spacing:.6px;
      box-shadow:0 8px 18px rgba(0,0,0,.25), inset 0 2px 0 rgba(255,255,255,.12);
      transform:translateZ(0);
      user-select:none;
    }
    .eco-score:not(.score-a):not(.score-b):not(.score-c):not(.score-d):not(.score-e){
      width:auto; height:auto; border-radius:10px; padding:4px 10px;
      background:rgba(255,255,255,.06); color:var(--muted); font-weight:600;
    }
    .score-a{ background:linear-gradient(180deg,#1fd46f,#16b260); color:#042216 }
    .score-b{ background:linear-gradient(180deg,#74dc57,#5cc643); color:#051a10 }
    .score-c{ background:linear-gradient(180deg,#ffd858,#f6c53e); color:#201600 }
    .score-d{ background:linear-gradient(180deg,#ffa14d,#f28324); color:#240f00 }
    .score-e{ background:linear-gradient(180deg,#ff6b6b,#e94b4b); color:#260808 }

    .muted{ color:var(--muted); font-size:.93rem }

    /* ====== Loader ====== */
    .loading{
      display:none; margin:18px auto;
      width:46px; height:46px; border-radius:999px;
      border:5px solid rgba(255,255,255,.12);
      border-top-color: var(--brand);
      animation:spin 1s linear infinite;
      box-shadow:0 0 0 3px rgba(43,208,122,.08) inset;
    }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    /* ====== Footer ====== */
    .footer{
      max-width:1040px; margin:28px auto 0; padding:20px 14px;
      color:var(--muted); font-size:.92rem; text-align:center;
      border-top:1px solid var(--border);
    }

    /* Small separators */
    .divider{
      height:1px; background:var(--border); margin:18px 0;
    }
  </style>
</head>
<body>

  <!-- Header / Branding -->
  <header class="app-header">
    <nav class="nav">
      <a class="brand" href="#">
        <span class="brand-badge">GS</span>
        <div>
          <div class="brand-title">GreenScan</div>
          <div class="tagline">Eco barcode checker</div>
        </div>
      </a>
      <div class="tagline">Scan • Upload • Type</div>
    </nav>
  </header>

  <main class="wrap">
    <div class="container">

      <!-- Left column: Scanner & Inputs -->
      <section class="card">
        <div class="card-head">
          <h2 class="card-title">Scan or Enter Barcode</h2>
        </div>
        <div class="card-body">
          <!-- Live Camera Scanner -->
          <div id="reader" class="scanner">Camera preview will appear here</div>
          <div class="btn-row" style="margin:10px 0 4px">
            <button id="start-scan" class="btn btn-green">📷 Start Camera Scan</button>
            <button id="stop-scan" class="btn btn-red">🛑 Stop Camera</button>
          </div>
          <p class="hint">For best results, use the rear camera in good lighting.</p>

          <div class="divider"></div>

          <!-- Upload Barcode Image -->
          <h3 style="margin:0 0 8px; font-size:1rem; color:#d9eee4">Upload a barcode image</h3>
          <input type="file" id="barcode-file" accept="image/*" />

          <div class="divider"></div>

          <!-- Manual Barcode Entry -->
          <h3 style="margin:0 0 8px; font-size:1rem; color:#d9eee4">Or type the barcode number</h3>
          <div class="split">
            <input class="input" type="text" id="barcode-input" placeholder="Enter barcode e.g. 3017620422003" />
            <button id="search-barcode" class="btn btn-blue">🔍 Search</button>
          </div>
          <div class="hint">Tip: EAN-13 barcodes are 13 digits (common for groceries).</div>

          <!-- Loader -->
          <div id="loader" class="loading"></div>
        </div>
      </section>

      <!-- Right column: Results -->
      <section class="card">
        <div class="card-head">
          <h2 class="card-title">Product Information</h2>
        </div>
        <div class="card-body">
          <div id="result" class="result-box">
            <div class="kv"><b>Name:</b> <span id="product-name">–</span></div>
            <div class="kv"><b>Eco-Score:</b> <span id="eco-score" class="eco-score">–</span></div>
            <div id="eco-explanation" class="eco-explanation">–</div>

            <!-- Fallback by Name -->
            <div id="fallback-box" style="margin-top:14px; padding-top:12px; border-top:1px dashed var(--border); display:none;">
              <p style="margin:.2rem 0 .6rem">❔ Can’t find it by barcode. Try searching by product name:</p>
              <div class="split" style="margin-bottom:8px">
                <input class="input" type="text" id="fallback-input" placeholder="e.g. instant noodles chicken" />
                <button id="fallback-search" class="btn" style="background:linear-gradient(180deg,#a26df5,#7b45d9); color:#14082b">Search by Name</button>
              </div>
              <div class="muted">We’ll query OpenFoodFacts and show the closest match.</div>
            </div>
          </div>
        </div>
      </section>

    </div>

    <footer class="footer">
      Hackathon Project • © 2025 GreenScan
    </footer>
  </main>

  <!-- =========================
       JavaScript (unchanged logic)
       ========================= -->
  <script>
    // =========================
    // Constants / helpers
    // =========================
    const PRODUCT_URL = "https://world.openfoodfacts.org/api/v0/product/";
    const SEARCH_URL_BASE =
      "https://world.openfoodfacts.org/cgi/search.pl?search_simple=1&json=1&action=process&fields=product_name,brands,ecoscore_grade,code&page_size=20&search_terms=";

    let html5QrcodeScanner;

    const $ = (sel) => document.querySelector(sel);
    const show = (el, on = true) => (el.style.display = on ? "block" : "none");

    function setEcoScore(grade) {
      const ecoEl = $("#eco-score");
      ecoEl.className = "eco-score"; // reset classes
      if (!grade) {
        ecoEl.textContent = "Not available";
        return;
      }
      const g = String(grade).trim().toLowerCase();
      ecoEl.textContent = g.toUpperCase();
      if (["a","b","c","d","e"].includes(g)) {
        ecoEl.classList.add(`score-${g}`);
      }
    }

    function showResult(nameText, grade) {
      $("#product-name").textContent = nameText || "Unknown product";
      setEcoScore(grade);
      show($("#result"), true);
    }

    function showFallback(on = true) {
      show($("#fallback-box"), on);
    }

    function brandPlusName(product) {
      const brand = product.brands ? product.brands.split(",")[0].trim() : "";
      const pname = product.product_name || "Unknown product";
      return brand ? `${brand} – ${pname}` : pname;
    }

    // ---- Eco-Score explanation helpers ----
    function setEcoExplanation(texts) {
      const box = document.querySelector("#eco-explanation");
      if (!box) return;
      if (!texts || texts.length === 0) {
        box.style.display = "none";
        box.textContent = "–";
        return;
      }
      box.innerHTML = texts.map(t => `• ${t}`).join("<br>");
      box.style.display = "block";
    }

    function explainFromGrade(grade) {
      const g = grade ? String(grade).toUpperCase() : null;
      const reasons = [];
      if (g === "A") reasons.push("Excellent sustainability. Low overall impact.");
      else if (g === "B") reasons.push("Good score. Mostly eco-friendly.");
      else if (g === "C") reasons.push("Average eco-score. Some concerns present.");
      else if (g === "D") reasons.push("Low eco-score. Noticeable environmental impact.");
      else if (g === "E") reasons.push("Very poor eco-score. High environmental impact.");
      else reasons.push("Eco-Score not available for this product.");
      setEcoExplanation(reasons);
    }

    function explainFromProduct(product) {
      // Start with a grade-based line
      const reasons = [];
      const grade = product?.ecoscore_grade ? String(product.ecoscore_grade).toUpperCase() : null;
      if (grade) {
        const map = {
          A: "Excellent sustainability. Low overall impact.",
          B: "Good score. Mostly eco-friendly.",
          C: "Average eco-score. Some concerns present.",
          D: "Low eco-score. Noticeable environmental impact.",
          E: "Very poor eco-score. High environmental impact.",
        };
        reasons.push(map[grade] || "Eco-Score not available for this product.");
      } else {
        reasons.push("Eco-Score not available for this product.");
      }

      // Extra lightweight checks from OFF fields
      const tags = product?.ingredients_analysis_tags || [];
      if (Array.isArray(tags) && tags.includes("en:palm-oil")) {
        reasons.push("Contains palm oil (linked to deforestation).");
      }

      const pkgStr = [
        product?.packaging_text,
        product?.packaging,
        Array.isArray(product?.packagings) ? product.packagings.map(p => p.material || "").join(" ") : ""
      ].filter(Boolean).join(" ").toLowerCase();
      if (pkgStr.includes("plastic")) {
        reasons.push("Packaging uses plastic.");
      }

      const nutr = product?.nutriments || {};
      let sat = nutr["saturated-fat_100g"];
      if (sat === undefined) sat = nutr["saturated-fat_serving"] ?? nutr["saturated-fat"];
      const satNum = typeof sat === "number" ? sat : parseFloat(sat);
      if (!Number.isNaN(satNum) && satNum > 5) {
        reasons.push("High in saturated fat.");
      }

      setEcoExplanation(reasons);
    }


    // =========================
    // Camera scanner
    // =========================
    $("#start-scan").addEventListener("click", () => {
      if (!html5QrcodeScanner) html5QrcodeScanner = new Html5Qrcode("reader");

      html5QrcodeScanner
        .start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            fetchProductByBarcode(decodedText);
            html5QrcodeScanner.stop();
          },
          (errorMsg) => {
            // scanning errors are noisy; keep console only
            console.warn("Scan error:", errorMsg);
          }
        )
        .catch((err) => console.error("Camera error:", err));
    });

    $("#stop-scan").addEventListener("click", () => {
      if (!html5QrcodeScanner) return;
      html5QrcodeScanner
        .stop()
        .then(() => html5QrcodeScanner.clear())
        .catch((err) => console.error("Stop error:", err));
    });

    // =========================
    // Upload image → decode barcode
    // =========================
    $("#barcode-file").addEventListener("change", async (e) => {
      if (!e.target.files || !e.target.files[0]) return;

      const file = e.target.files[0];
      const img = document.createElement("img");
      img.style.position = "fixed";
      img.style.left = "-9999px"; // offscreen but in DOM
      img.src = URL.createObjectURL(file);
      document.body.appendChild(img);

      img.onload = async () => {
        try {
          // "Try harder" hints improve decoding of tricky photos
          const hints = new Map();
          hints.set(ZXing.DecodeHintType.TRY_HARDER, true);

          const reader = new ZXing.BrowserMultiFormatReader(hints);
          const result = await reader.decodeFromImageElement(img);
          fetchProductByBarcode(result.text);
        } catch (err) {
          console.error("Decode error:", err);
          showResult("❌ Could not read barcode from image", null);
          showFallback(true);
        } finally {
          document.body.removeChild(img);
        }
      };
    });

    // =========================
    // Manual barcode entry
    // =========================
    $("#search-barcode").addEventListener("click", () => {
      const code = $("#barcode-input").value.trim();
      if (!code) return;
      fetchProductByBarcode(code);
    });

    // =========================
    // Fallback name search
    // =========================
    $("#fallback-search").addEventListener("click", () => {
      const q = $("#fallback-input").value.trim();
      if (!q) return;
      searchByName(q);
    });

    // =========================
    // OpenFoodFacts lookups
    // =========================
    async function fetchProductByBarcode(barcode) {
      show($("#loader"), true);
      showFallback(false);
      showResult("Fetching product…", null);
      setEcoExplanation(null); // hide explanation while loading


      try {
        const res = await fetch(`${PRODUCT_URL}${encodeURIComponent(barcode)}.json`);
        const data = await res.json();

        if (data && data.status === 1) {
          const product = data.product || {};
          const name = brandPlusName(product);
          const grade = product.ecoscore_grade || null;
          showResult(name, grade);
          explainFromProduct(product); // fill the explanation box

        } else {
          showResult("❌ Not found by barcode", null);
          showFallback(true);
        }
      } catch (err) {
        console.error(err);
        showResult("⚠️ Error fetching product", null);
        showFallback(true);
      } finally {
        show($("#loader"), false);
      }
    }

    async function searchByName(nameQuery) {
      show($("#loader"), true);
      showResult(`Searching for “${nameQuery}”…`, null);
      setEcoExplanation(null); // hide while searching

      try {
        const url = SEARCH_URL_BASE + encodeURIComponent(nameQuery);
        const res = await fetch(url);
        const data = await res.json();

        const list = (data && Array.isArray(data.products)) ? data.products : [];
        if (list.length === 0) {
          showResult("❌ No product found by that name", null);
          setEcoExplanation(["No matching products in OpenFoodFacts."]);
          return;
        }

        // Prefer the first product that has an ecoscore
        let chosen = list.find(p => p.ecoscore_grade) || list[0];
        const name = brandPlusName(chosen);
        const grade = chosen.ecoscore_grade || null;

        // If we have a barcode code, fetch full product to get packaging/nutriments for explanations
        if (chosen.code) {
          const res2 = await fetch(`${PRODUCT_URL}${encodeURIComponent(chosen.code)}.json`);
          const data2 = await res2.json();
          if (data2 && data2.status === 1 && data2.product) {
            const full = data2.product;
            const fullName = brandPlusName(full);
            const fullGrade = full.ecoscore_grade || grade || null;
            showResult(fullName, fullGrade);
            explainFromProduct(full);
            showFallback(false);
            return;
          }
        }

        // Fallback: show basic result + grade-only explanation
        showResult(name, grade);
        explainFromGrade(grade);
        showFallback(false);
      } catch (err) {
        console.error(err);
        showResult("⚠️ Error searching by name", null);
        setEcoExplanation(null);
      } finally {
        show($("#loader"), false);
      }
    }


    // Keep the result box visible with placeholders on first load
    showResult("–", null);
  </script>
</body>
</html>
